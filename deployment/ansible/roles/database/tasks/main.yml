---
# This Playbook installs the database environment

- name: Update apt cache
  apt:
    update_cache: yes

- name: Set MySQL password
  shell: debconf-set-selections <<< 'mysql-server mysql-server/root_password password root'

- name: Set MySQL password again
  shell: debconf-set-selections <<< 'mysql-server mysql-server/root_password_again password root'

- name: Install MySQL Server
  apt:
    name: mysql-server
    state: present

- name: Stop MySQL server service
  service:
    name: mysql
    state: stopped

- name: Create volume directory
  file:
    path: "{{ database_data_path }}"
    state: directory
    mode: 0755

- name: Mount data volume
  mount:
    name: "{{ database_data_path }}"
    src: "{{ volume_device }}"
    fstype: nfs
    state: present

- name: Copy MySQL configuration
  template:
    src: mysqld.cnf.j2
    dest: /etc/mysql/mysql.conf.d/mysqld.cnf
    owner: root
    mode: 0644

- name: Copy apparmor configuration
  template:
    src: alias.j2
    dest: /etc/apparmor.d/tunables/alias
    owner: root
    mode: 0644

- name: Restart Apparmor service
  service:
    name: apparmor
    state: restarted

- name: Create mysql config folder
  file:
    path: /var/lib/mysql/mysql
    state: directory
    mode: 0755

- name: Start MySQL service
  service:
    name: mysql
    state: started
